使用consul作为 DNS\注册中心\配置中心\Spring Cloud Bus
consul agent -server -bootstrap -advertise=10.2.107.218 -data-dir=./data -ui-dir=./web_ui

使用docker安装部署consul
docker pull consul

注意server的-bootstrap-expect必须相同，-node必须不同，这样就开启了3台server
docker run -d --restart=always --net=host --name=consul-server 10.3.32.86:5000/consul agent -ui -server -node=86 -bind=10.3.32.86 -client=10.3.32.86 -data-dir /tmp/consul -bootstrap-expect 3
docker run -d --restart=always --net=host --name=consul-server 10.3.32.86:5000/consul agent -ui -server -node=97 -bind=10.3.32.97 -client=10.3.32.97 -data-dir /tmp/consul -bootstrap-expect 3
docker run -d --restart=always --net=host --name=consul-server 10.3.32.86:5000/consul agent -ui -server -node=98 -bind=10.3.32.98 -client=10.3.32.98 -data-dir /tmp/consul -bootstrap-expect 3


其他两台加入进来组成集群
docker exec -t consul-server consul join -rpc-addr=10.3.32.97:8400 10.3.32.86
docker exec -t consul-server consul join -rpc-addr=10.3.32.98:8400 10.3.32.86

访问http://10.3.32.78:8500/查看状态




开启服务提供者与消费者，注册中心可以用同一个，docker容器内执行，需要指明访问的外部ip及端口
docker run -t -p 8080:8080 --name=provider -v /root/exchange:/root/exchange java java -Dspring.cloud.consul.host=10.3.32.86 -Dspring.cloud.consul.discovery.ipAddress=10.3.32.86 -Dspring.cloud.consul.discovery.port=8080 -jar /root/exchange/spring-cloud-provider-DEV-SNAPSHOT.jar

docker run -t -p 8090:8080 --name=consumer -v /root/exchange:/root/exchange java java -Dspring.cloud.consul.host=10.3.32.86 -Dspring.cloud.consul.discovery.ipAddress=10.3.32.97 -Dspring.cloud.consul.discovery.port=8090 -jar /root/exchange/spring-cloud-consumer-DEV-SNAPSHOT.jar
docker run -t -p 8090:8080 --name=consumer -v /root/exchange:/root/exchange java java -Dspring.cloud.consul.host=10.3.32.86 -Dspring.cloud.consul.discovery.ipAddress=10.3.32.98 -Dspring.cloud.consul.discovery.port=8090 -jar /root/exchange/spring-cloud-consumer-DEV-SNAPSHOT.jar

关闭78上的consul-server，显示注册到78上的服务均failing，其实只是Serf Health Status failing，服务健康，也可正常访问，consul的最佳实践? 每个微服务自建consul-client?


docker swarm overlay 网络
docker network create --driver overlay --subnet 172.20.0.0/24 mc
下面命令只能通过控制台执行，无法通过portainer webUI执行
docker service create \
  --network=mc \
  --name=consul \
  -e CONSUL_BIND_INTERFACE=eth2 \
  --mode global \
  -p 8500:8500 \
  10.3.32.86:5000/consul agent -server -ui -client=0.0.0.0 \
  -bootstrap-expect 1 \
  -retry-join 172.20.0.3
